# Project 4: Automating TLS Certificates with ACME for Azure Resources

⚙️ Draft version — content under review and subject to updates.

## Context

A significant number of the organisation's public-facing workloads relied on manually generated CSRs, CA-ordered certificates imported as PFX files into Azure Key Vault, and portal-based binding to App Service/Application Gateway. 

This created overhead and renewal risks — compounded by the existing CA ceasing operations and industry shift to 90-day certificates (driven by browsers like Chrome)

The aim of this project was to automate certificate issuance and renewal using **the ACME protocol** (as implemented by Let’s Encrypt) and integrate it with **Azure App Service**, **Application Gateway**, and **Key Vault‑based endpoints**.

## Requirements

- Remove manual certificate management from operational workflows.  
- Automate issuance, renewal, and binding of certificates using ACME‑compatible tooling.  
- Support **Azure App Service** custom domains and **Application Gateway** listeners.
- Support certificates for backend VMs to enable passthrough encryption. 
- Store and manage certificates in **Azure Key Vault** for centralized lifecycle control.  
- Integrate with IaC pipelines (Terraform) to ensure repeatable provisioning.  
- Conform to corporate security policies for key size, expiration, and renewal intervals.

## Architecture

- **Certificate Issuer:** Let’s Encrypt configured via ACME client automation (via the `vancluever/acme` provider in Terraform).  
- **Storage:** Certificates and keys stored securely in Azure Key Vault with RBAC‑scoped access.
- **Integration:** Scheduled **Azure DevOps pipelines** trigger ACME renewal workflows 30 days before expiry (replacing manual processes).
  - Updated certificates automatically detected and re-bound by **App Service** and **Application Gateway** via Key Vault polling.
- **IaC:** Terraform provisions **Key Vault**, access policies, and user-assigned **Managed Identities** for service access.
- **Monitoring:** Azure Monitor alerts on near‑expiry certificates and renewal failures.

## Key Decisions

- Standardised on **Azure Key Vault** as the single source of truth for all TLS materials.
- Used **Managed Identities** for secure authentication between services (VMs, App Service, Application Gateway) and Key Vault — no stored credentials.
- ACME configuration exposed as **Terraform variables** and pipeline parameters for environment reusability.

## Operations

- Renewal pipeline triggers automatically 30 days before certificate expiry.
- Add or remove certificates to be generated by updating the relevant Terraform variable on a per environment basis.
- Pipeline renewal failures reported via **email summaries** and **Teams channel integration**.

## Future Enhancements

- Consolidate renewal telemetry (pipelines, Key Vault logs, Monitor metrics) into central **Azure Workbook** dashboard.
- Integrate Key Vault notifications with **Microsoft Defender for Cloud** for compliance monitoring.
- Document comprehensive break-glass procedures for emergency certificate management.

## Code References

NOTE: These references are placeholders and should be updated when the `/code` directory structure is finalised.

- `/code/project4-terraform/` — Terraform for Key Vault, ACME provider (`vancluever/acme`), Azure DevOps Pipelines, App Service, and Application Gateway integration.
- `/docs/common/` — Shared governance, naming, and policy enforcement examples.
